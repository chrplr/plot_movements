#!/usr/bin/env Rscript
# plot realignement parameters in rp*.txt files in the current dirs, or in files passed as arguments
# Time-stamp: <2013-02-13 16:17 christophe@pallier.org>

outfile <- "movements.pdf"
pdf_viewer <- "evince"

rpfiles <- commandArgs(TRUE)

if (length(rpfiles)==0)
    rpfiles = Sys.glob('rp*.txt')

if (rpfiles[1] %in% c('--help','-h','-help'))
{
    write("Plots (x,y,z,pitch,roll, yaw) movements parameters files generated by spm_realign\nAuthor: christophe@pallier.org", stderr());
   q();
}


print(paste(rpfiles,sep="\n"))


rp <- data.frame(x=numeric(0), y=numeric(0), z=numeric(0),
                pitch=numeric(0), roll=numeric(0), yaw=numeric(0))

nscans <- c()

for (f in rpfiles)
{
    cur <- read.table(f, col.names=names(rp))
    rp <- rbind(rp, cur)
    nscans <- c(nscans, nrow(cur))
}
nscans <- cumsum(nscans)

n <- nrow(rp)
scans <- 1:n

print(names(rp))

# convert radians into degrees
rp[,4:6] <- rp[,4:6] * 180/pi


pdf(outfile, width=6, height=8)


par(mfrow=c(2,1),las=1, oma=c(2,2,2,2))


ylim=c(min(rp[,1:3]*1.1,-1), max(rp[,1:3]*1.1,1))
mins <- lapply(rp, min)
maxs <- lapply(rp, max)
differences <- unlist(maxs)-unlist(mins)
print(differences)

matplot(scans, rp[,c('x','y','z')],
        main="Translations",
        xlab='',
        ylab='mm',type='l',lty=1, ylim=ylim)
grid()
legend('top',horiz=TRUE
       , col=1:3,names(rp)[1:3],lty=1)
for (i in nscans) abline(v=i, lty=2, lwd=.5)

ylim=c(min(rp[,4:6]*1.1,-1),max(rp[,4:6]*1.1,1))
matplot(scans, rp[,4:6],ylab='degrees',
        type='l',
        main="Rotations", lty=1, ylim=ylim)
grid()
legend('top',horiz=TRUE, col=1:3,names(rp)[4:6],lty=1)
for (i in nscans) abline(v=i, lty=2, lwd=.5)

title <- getwd()
title <- substring(title, max(1,nchar(title)-32))
mtext(title, side=3, line=0.5, cex=1.2, col="blue", outer=TRUE)

mtext(paste("deltas=",paste(signif(differences,3), collapse=", ")), side=1, line=0.5, col='red', outer=TRUE)

graphics.off()

system(paste(pdf_viewer, outfile), wait=FALSE)

